<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Blackjack - Casino de la D√®che</title>
    <style>
        body { background: #076324; color: white; text-align: center; font-family: 'Arial', sans-serif; }
        .table-container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .hud { background: rgba(0,0,0,0.7); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 2px solid gold; display: flex; justify-content: space-around; font-size: 20px; }
        .tapis { border: 12px solid #3d2b1f; border-radius: 60px; padding: 30px; background: radial-gradient(#1a8c43, #076324); box-shadow: 0 10px 50px rgba(0,0,0,0.6); min-height: 450px; position: relative; }
        .carte { background: white; color: black; width: 80px; height: 110px; border-radius: 10px; display: inline-block; margin: 5px; font-weight: bold; font-size: 22px; border: 2px solid #999; vertical-align: top; box-shadow: 3px 3px 10px rgba(0,0,0,0.3); }
        .carte div { margin-top: 10px; }
        .rouge { color: #e74c3c; }
        .btn { padding: 15px 30px; font-size: 18px; cursor: pointer; border: none; border-radius: 10px; font-weight: bold; margin: 10px; transition: 0.2s; }
        .btn:hover:not(:disabled) { transform: scale(1.1); }
        .btn-hit { background: gold; color: black; box-shadow: 0 4px 0 #b8860b; }
        .btn-stand { background: #e74c3c; color: white; box-shadow: 0 4px 0 #822a20; }
        .btn:disabled { background: #555 !important; color: #888 !important; box-shadow: none; cursor: not-allowed; }
        #ecran-overlay { background: rgba(0,0,0,0.95); position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        #status-bar { font-size: 28px; color: gold; margin-bottom: 20px; height: 40px; text-shadow: 2px 2px 4px black; font-weight: bold; }
        input { padding: 10px; font-size: 20px; width: 120px; text-align: center; border-radius: 5px; border: none; }
    </style>
</head>
<body>
    <div id="ecran-overlay">
        <h1 style="color:gold; font-size: 50px;">BLACKJACK</h1>
        <p>Votre solde : <span id="solde-overlay" style="color:#2ecc71; font-weight:bold;">...</span>$</p>
        <div>
            <label>Mise : </label>
            <input type="number" id="input-mise" value="100" min="10">
        </div>
        <br>
        <button class="btn" style="background: #2ecc71; color: white;" onclick="validerMise()">üí∞ JOUER</button>
        <div id="msg-attente" style="display:none; color: gold; margin-top: 20px;">Attente des autres joueurs...</div>
    </div>

    <div class="table-container">
        <div class="hud">
            <div>üë§ <span id="mon-pseudo">Joueur</span></div>
            <div>üí∞ <span id="mon-solde">0</span>$</div>
        </div>

        <div class="tapis">
            <div id="status-bar">Bienvenue √† la table</div>
            
            <div id="zone-croupier">
                <h3 style="color: rgba(255,255,255,0.8);">CROUPIER : <span id="score-croupier">0</span></h3>
                <div id="cartes-croupier" style="min-height: 120px;"></div>
            </div>

            <hr style="border: 0; border-top: 2px dashed rgba(255,255,255,0.1); margin: 30px 0;">

            <div id="zone-joueur">
                <div id="mes-mains"></div>
            </div>
        </div>

        <div class="zone-actions">
            <button id="btn-hit" class="btn btn-hit" onclick="tirer()" disabled>HIT</button>
            <button id="btn-stand" class="btn btn-stand" onclick="arreter()" disabled>STAND</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let pseudo = localStorage.getItem('casino_pseudo');
        if(!pseudo) window.location.href = "/";

        socket.emit('nouveauJoueur', pseudo);
        document.getElementById('mon-pseudo').innerText = pseudo;

        // Synchronisation du solde avec le serveur
        socket.on('initSolde', s => {
            document.getElementById('mon-solde').innerText = s;
            document.getElementById('solde-overlay').innerText = s;
        });

        function validerMise() {
            const m = parseInt(document.getElementById('input-mise').value);
            socket.emit('joueurPret', m);
            document.getElementById('msg-attente').style.display = "block";
        }

        // √âv√©nement principal : Mise √† jour globale de la table
        socket.on('miseAJourTable', d => {
            // 1. Affichage du Croupier
            const divCroupier = document.getElementById('cartes-croupier');
            divCroupier.innerHTML = "";
            d.mainCroupier.forEach(c => divCroupier.innerHTML += creerCardHTML(c));
            
            // Calculer et afficher score croupier localement pour r√©activit√©
            document.getElementById('score-croupier').innerText = "En cours..."; 

            // 2. Affichage de mes mains
            const moi = d.joueurs[socket.id];
            const divMains = document.getElementById('mes-mains');
            divMains.innerHTML = "";
            if(moi && moi.mains && moi.mains.length > 0) {
                moi.mains.forEach(m => {
                    let mainDiv = document.createElement('div');
                    let cartesHtml = "";
                    m.cartes.forEach(c => cartesHtml += creerCardHTML(c));
                    mainDiv.innerHTML = `${cartesHtml} <div style="font-size:20px; font-weight:bold; margin-top:5px;">Score: ${m.score}</div>`;
                    divMains.appendChild(mainDiv);
                });
            }

            // 3. Gestion des boutons et Overlay
            if (d.etatBlackjack === 'LOBBY') {
                document.getElementById('ecran-overlay').style.display = "flex";
                document.getElementById('msg-attente').style.display = "none";
                gererBoutons(false);
            } else if (d.etatBlackjack === 'JEU') {
                document.getElementById('ecran-overlay').style.display = "none";
                gererBoutons(d.idActif === socket.id);
            } else {
                gererBoutons(false); // Tour du croupier ou fin
            }
        });

        // Quand le croupier tire ses cartes finales
        socket.on('croupierTire', d => {
            const divCroupier = document.getElementById('cartes-croupier');
            divCroupier.innerHTML += creerCardHTML(d.carte);
            document.getElementById('score-croupier').innerText = d.scoreTotal;
        });

        socket.on('debutPartie', d => {
            document.getElementById('ecran-overlay').style.display = "none";
            // On laisse 'miseAJourTable' faire le gros du travail d'affichage
        });

        socket.on('finPartie', d => {
            document.getElementById('score-croupier').innerText = d.scoreCroupier;
            document.getElementById('status-bar').innerText = "PARTIE TERMIN√âE !";
            document.getElementById('status-bar').style.color = "white";
        });

        socket.on('retourLobby', () => {
            document.getElementById('ecran-overlay').style.display = "flex";
            document.getElementById('msg-attente').style.display = "none";
            document.getElementById('cartes-croupier').innerHTML = "";
            document.getElementById('mes-mains').innerHTML = "";
        });

        // Fonctions d'actions
        function tirer() { socket.emit('demanderCarte'); }
        function arreter() { socket.emit('stand'); }

        function gererBoutons(actif) {
            document.getElementById('btn-hit').disabled = !actif;
            document.getElementById('btn-stand').disabled = !actif;
            document.getElementById('status-bar').innerText = actif ? "üü¢ √Ä VOUS DE JOUER" : "Attente du tour...";
            document.getElementById('status-bar').style.color = actif ? "gold" : "white";
        }

        function creerCardHTML(c) {
            const rouge = ['‚ô•Ô∏è', '‚ô¶Ô∏è'].includes(c.symbole) ? 'rouge' : '';
            return `<div class="carte ${rouge}"><div>${c.valeur}</div><div>${c.symbole}</div></div>`;
        }
    </script>
</body>
</html>